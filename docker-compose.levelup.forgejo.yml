services:
  forgejo:
    image: codeberg.org/forgejo/forgejo:14.0.2
    container_name: visor-levelup-forgejo
    env_file:
      - .levelup.env
    environment:
      - TZ=${TZ:-Europe/Vienna}
      # skip web installer on first start
      - FORGEJO__security__INSTALL_LOCK=true
      # push-to-create: git push to non-existent repo creates it automatically
      - FORGEJO__repository__ENABLE_PUSH_CREATE_USER=true
      - FORGEJO__server__HTTP_PORT=3000
      - FORGEJO__server__DOMAIN=git.visor.${PROXY_DOMAIN}
      - FORGEJO__server__ROOT_URL=https://git.visor.${PROXY_DOMAIN}/
      # pass admin credentials for bootstrap script
      - FORGEJO_ADMIN_USER=${FORGEJO_ADMIN_USER:-visor}
      - FORGEJO_ADMIN_PASSWORD=${FORGEJO_ADMIN_PASSWORD}
      - FORGEJO_ADMIN_EMAIL=${FORGEJO_ADMIN_EMAIL:-visor@localhost}
    volumes:
      - /root/code/visor/data/levelups/forgejo:/data
    # override CMD only — dumb-init entrypoint stays intact
    # starts forgejo normally, then runs first-run bootstrap once
    # token is written to /data/visor-push.token for visor to read
    command:
      - /bin/sh
      - -c
      - |
        /usr/bin/entrypoint &
        FPID=$!
        until wget -qO- http://localhost:3000/api/v1/version >/dev/null 2>&1; do sleep 2; done
        if [ ! -f /data/.bootstrap-done ]; then
          forgejo admin user create --admin \
            --username "${FORGEJO_ADMIN_USER}" \
            --password "${FORGEJO_ADMIN_PASSWORD}" \
            --email "${FORGEJO_ADMIN_EMAIL}" 2>/dev/null || true
          forgejo admin user generate-access-token \
            --username "${FORGEJO_ADMIN_USER}" \
            --token-name visor-push \
            --raw > /data/visor-push.token 2>/dev/null || true
          touch /data/.bootstrap-done
          echo "Forgejo bootstrap complete — token at /data/visor-push.token"
        fi
        wait $FPID
    expose:
      - "3000"
    networks:
      - proxy
      - levelup-forgejo
    restart: unless-stopped

networks:
  proxy:
    name: visor-proxy
  levelup-forgejo:
    name: visor-levelup-forgejo
